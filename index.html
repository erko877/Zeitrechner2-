<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WorkTime Pro">
    <meta name="mobile-web-app-capable" content="yes">
    
    <title>WorkTime Pro | Erko 2026</title>
    
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/4305/4305432.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/4305/4305432.png" type="image/png">

    <style>
        :root {
            --bg-gradient: radial-gradient(at 0% 0%, #1e1b4b 0, transparent 50%), 
                           radial-gradient(at 100% 0%, #312e81 0, transparent 50%), 
                           radial-gradient(at 100% 100%, #4338ca 0, transparent 50%), 
                           radial-gradient(at 0% 100%, #1e1b4b 0, transparent 50%);
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.15);
            --glass-text: #f8fafc;
            --primary: #818cf8;
            --success: #34d399;
            --danger: #fb7185;
            --accent: #22d3ee;
            --gold-gradient: linear-gradient(90deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        }

        [data-theme="light"] {
            --bg-gradient: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            --glass: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.05);
            --glass-text: #1e293b;
            --primary: #4f46e5;
        }

        html, body { overscroll-behavior-y: contain; }
        * { box-sizing: border-box; font-family: 'Inter', -apple-system, sans-serif; margin: 0; padding: 0; transition: background 0.5s ease; }

        body {
            background: var(--bg-gradient); background-color: #0f172a;
            min-height: 100vh; display: flex; align-items: center; justify-content: center;
            color: var(--glass-text); padding: 10px;
        }

        .dashboard { width: 100%; max-width: 900px; display: grid; grid-template-columns: 1fr 1.4fr; gap: 20px; }

        @media (max-width: 800px) {
            .dashboard { grid-template-columns: 1fr; }
            body { align-items: flex-start; padding-top: 40px; }
        }

        .glass-card {
            background: var(--glass); backdrop-filter: blur(25px); -webkit-backdrop-filter: blur(25px);
            border: 1px solid var(--glass-border); border-radius: 25px; padding: 25px;
            box-shadow: 0 20px 40px -10px rgba(0, 0, 0, 0.5);
        }

        h1 { font-size: 22px; font-weight: 800; text-align: center; margin-bottom: 20px; background: linear-gradient(to right, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        label { display: block; font-size: 10px; font-weight: 700; text-transform: uppercase; color: var(--primary); margin-bottom: 6px; }

        .input-row { display: flex; gap: 8px; margin-bottom: 15px; }
        input { width: 100%; padding: 12px; border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(0, 0, 0, 0.2); color: white; font-size: 16px; outline: none; -webkit-appearance: none; }
        [data-theme="light"] input { background: rgba(255, 255, 255, 0.5); color: #1e293b; }

        .btn-icon { background: var(--primary); border: none; color: white; width: 48px; border-radius: 12px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 18px; }

        .progress-wrapper { position: relative; height: 16px; background: rgba(0,0,0,0.3); border-radius: 8px; margin: 25px 0; border: 1px solid var(--glass-border); overflow: hidden; }
        #progress-bar { height: 100%; width: 0%; background: var(--danger); transition: width 0.6s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        @keyframes shine { to { background-position: 200% center; } }
        .gold-shimmer { background: var(--gold-gradient) !important; background-size: 200% auto !important; animation: shine 3s linear infinite; box-shadow: 0 0 20px rgba(212, 175, 55, 0.5) !important; }

        .marker { position: absolute; left: 77.7%; top: 0; bottom: 0; width: 2px; background: white; z-index: 5; }

        .finish-card { background: linear-gradient(135deg, rgba(129, 140, 248, 0.2), rgba(34, 211, 238, 0.2)); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; text-align: center; margin-bottom: 20px; }
        .finish-time { font-size: 32px; font-weight: 900; color: var(--accent); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .stat-box { background: rgba(0,0,0,0.2); padding: 15px; border-radius: 18px; text-align: center; border: 1px solid var(--glass-border); }

        .save-btn { width: 100%; padding: 14px; border-radius: 15px; border: none; background: var(--success); color: #064e3b; font-weight: 800; font-size: 15px; cursor: pointer; margin-top: 15px; }

        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 12px 5px; border-bottom: 1px solid var(--glass-border); font-size: 12px; cursor: pointer; }
        .history-item:active { background: rgba(255,255,255,0.05); }
        .week-separator { margin-top: 20px; padding-bottom: 5px; border-bottom: 1.5px solid var(--accent); display: flex; justify-content: space-between; font-size: 10px; font-weight: 800; color: var(--accent); }

        .delete-btn { color: var(--danger); background: none; border: none; font-size: 18px; padding-left: 10px; cursor: pointer; }

        /* MODAL STYLES */
        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.7); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { width: 100%; max-width: 350px; }

        .theme-toggle { position: fixed; top: 15px; right: 15px; background: var(--glass); border: 1px solid var(--glass-border); color: white; padding: 10px; border-radius: 50%; z-index: 100; }
    </style>
</head>
<body>

    <button class="theme-toggle" onclick="toggleTheme()">ðŸŒ“</button>

    <!-- EDIT MODAL -->
    <div class="modal-overlay" id="editModal">
        <div class="glass-card modal-content">
            <h1 id="editDateTitle">Tag bearbeiten</h1>
            <input type="hidden" id="editId">
            
            <label>Beginn</label>
            <input type="time" id="editStart" style="margin-bottom: 15px;">
            
            <label>Ende</label>
            <input type="time" id="editEnd" style="margin-bottom: 15px;">
            
            <label>Pause (Minuten)</label>
            <input type="number" id="editPause" style="margin-bottom: 20px;">
            
            <div style="display: flex; gap: 10px;">
                <button class="save-btn" onclick="saveEdit()" style="margin-top: 0;">Speichern</button>
                <button class="save-btn" onclick="closeEdit()" style="margin-top: 0; background: rgba(255,255,255,0.1); color: white;">Abbrechen</button>
            </div>
        </div>
    </div>

    <div class="dashboard">
        <div class="controls glass-card">
            <h1>WorkTime Pro</h1>
            
            <label>Beginn</label>
            <div class="input-row">
                <input type="time" id="start" value="08:00" oninput="calculate()">
                <button class="btn-icon" onclick="setNow('start')">ðŸ•’</button>
            </div>

            <label>Ende</label>
            <div class="input-row">
                <input type="time" id="end" value="15:30" oninput="calculate()">
                <button class="btn-icon" onclick="setNow('end')">ðŸ•’</button>
            </div>

            <label>Pause (Min)</label>
            <input type="number" id="pause" value="30" oninput="calculate()" style="margin-bottom: 20px;">

            <div id="history-container" style="display:none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                    <label>Historie (Tippen zum Editieren)</label>
                    <div>
                        <button onclick="exportCSV()" style="font-size: 9px; padding: 4px 8px; background: none; border: 1px solid var(--glass-border); color: white; border-radius: 5px;">CSV</button>
                        <button onclick="clearHistory()" style="font-size: 9px; padding: 4px 8px; background: none; border: 1px solid var(--danger); color: var(--danger); border-radius: 5px; margin-left: 5px;">Reset</button>
                    </div>
                </div>
                <div id="history-list"></div>
            </div>
        </div>

        <div class="visuals glass-card">
            <div class="finish-card">
                <label style="color: #fff; opacity: 0.7;">Feierabend bei 7h</label>
                <div id="predicted-end" class="finish-time">--:--</div>
            </div>

            <div class="progress-section">
                <div class="progress-wrapper">
                    <div class="marker"></div>
                    <div id="progress-bar"></div>
                </div>
            </div>

            <div class="stats-grid">
                <div class="stat-box">
                    <label>Netto</label>
                    <div id="net-total" style="font-size: 18px; font-weight: 800;">0h 0m</div>
                </div>
                <div class="stat-box">
                    <label>Saldo</label>
                    <div id="overtime" style="font-size: 18px; font-weight: 800;">0h 0m</div>
                </div>
            </div>

            <button class="save-btn" onclick="saveDay()">TAG SPEICHERN</button>
            <p style="text-align: center; font-size: 9px; opacity: 0.3; margin-top: 15px;">&copy; Erko 2026</p>
        </div>
    </div>

    <script>
        function toggleTheme() {
            const doc = document.documentElement;
            doc.setAttribute('data-theme', doc.getAttribute('data-theme') === 'dark' ? 'light' : 'dark');
        }

        function setNow(id) {
            const now = new Date();
            const t = now.getHours().toString().padStart(2, '0') + ":" + now.getMinutes().toString().padStart(2, '0');
            document.getElementById(id).value = t;
            calculate();
        }

        function getWeekNumber(d) {
            d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
            d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7));
            var yearStart = new Date(Date.UTC(d.getUTCFullYear(), 0, 1));
            return Math.ceil((((d - yearStart) / 86400000) + 1) / 7);
        }

        function formatTime(mins) {
            const abs = Math.abs(mins);
            return `${Math.floor(abs / 60)}h ${abs % 60}m`;
        }

        function calculateInternal(start, end, pause) {
            const [sh, sm] = start.split(':').map(Number);
            const [eh, em] = end.split(':').map(Number);
            let st = sh * 60 + sm; let et = eh * 60 + em;
            if (et < st) et += 1440;
            const net = et - st - parseInt(pause);
            return { net, ot: net - 420 };
        }

        function calculate() {
            const startVal = document.getElementById('start').value;
            const endVal = document.getElementById('end').value;
            const pauseVal = parseInt(document.getElementById('pause').value) || 0;
            if (!startVal || !endVal) return;

            const res = calculateInternal(startVal, endVal, pauseVal);
            const targetMin = 420; const maxViewMin = 540; 

            const pTotal = (Number(startVal.split(':')[0])*60 + Number(startVal.split(':')[1])) + targetMin + pauseVal;
            const ph = Math.floor((pTotal % 1440) / 60);
            const pm = pTotal % 60;
            document.getElementById('predicted-end').innerText = `${ph.toString().padStart(2, '0')}:${pm.toString().padStart(2, '0')} Uhr`;

            document.getElementById('net-total').innerText = formatTime(res.net);
            const otEl = document.getElementById('overtime');
            otEl.innerText = (res.ot >= 0 ? "+" : "") + formatTime(res.ot);
            otEl.style.color = res.ot >= 0 ? "var(--success)" : "var(--danger)";

            const bar = document.getElementById('progress-bar');
            const perc = Math.min((res.net / maxViewMin) * 100, 100);
            bar.style.width = perc + "%";
            bar.classList.remove('gold-shimmer');
            if (res.net < targetMin) bar.style.background = "var(--danger)";
            else { bar.style.background = "var(--success)"; if (res.net > targetMin) bar.classList.add('gold-shimmer'); }
        }

        function saveDay() {
            const now = new Date();
            const startVal = document.getElementById('start').value;
            const endVal = document.getElementById('end').value;
            const pauseVal = document.getElementById('pause').value;
            const res = calculateInternal(startVal, endVal, pauseVal);

            const data = {
                id: Date.now(),
                week: getWeekNumber(now),
                year: now.getFullYear(),
                dateDisplay: now.toLocaleDateString('de-DE', {weekday: 'short', day: '2-digit', month: '2-digit'}),
                fullDate: now.toLocaleDateString('de-DE'),
                start: startVal, end: endVal, pause: pauseVal,
                netMin: res.net, otText: (res.ot >= 0 ? "+" : "") + formatTime(res.ot)
            };

            let history = JSON.parse(localStorage.getItem('workHistoryFull') || '[]');
            history.unshift(data);
            localStorage.setItem('workHistoryFull', JSON.stringify(history));
            renderHistory();
        }

        /* --- EDIT FUNKTIONEN --- */
        function openEdit(id) {
            let history = JSON.parse(localStorage.getItem('workHistoryFull') || '[]');
            const item = history.find(i => i.id === id);
            if (!item) return;

            document.getElementById('editId').value = item.id;
            document.getElementById('editDateTitle').innerText = item.dateDisplay;
            document.getElementById('editStart').value = item.start;
            document.getElementById('editEnd').value = item.end;
            document.getElementById('editPause').value = item.pause;
            document.getElementById('editModal').style.display = 'flex';
        }

        function closeEdit() { document.getElementById('editModal').style.display = 'none'; }

        function saveEdit() {
            const id = Number(document.getElementById('editId').value);
            const start = document.getElementById('editStart').value;
            const end = document.getElementById('editEnd').value;
            const pause = document.getElementById('editPause').value;
            
            let history = JSON.parse(localStorage.getItem('workHistoryFull') || '[]');
            const index = history.findIndex(i => i.id === id);
            
            if (index !== -1) {
                const res = calculateInternal(start, end, pause);
                history[index].start = start;
                history[index].end = end;
                history[index].pause = pause;
                history[index].netMin = res.net;
                history[index].otText = (res.ot >= 0 ? "+" : "") + formatTime(res.ot);
                
                localStorage.setItem('workHistoryFull', JSON.stringify(history));
                renderHistory();
                closeEdit();
            }
        }

        function deleteDay(e, id) {
            e.stopPropagation(); // Verhindert das Ã–ffnen des Edit-Modals
            if (!confirm("Tag lÃ¶schen?")) return;
            let history = JSON.parse(localStorage.getItem('workHistoryFull') || '[]');
            history = history.filter(item => item.id !== id);
            localStorage.setItem('workHistoryFull', JSON.stringify(history));
            renderHistory();
        }

        function clearHistory() {
            if (confirm("Alles lÃ¶schen?")) { localStorage.removeItem('workHistoryFull'); renderHistory(); }
        }

        function renderHistory() {
            const history = JSON.parse(localStorage.getItem('workHistoryFull') || '[]');
            const list = document.getElementById('history-list');
            const container = document.getElementById('history-container');
            if(history.length === 0) { container.style.display = 'none'; return; }
            container.style.display = 'block';
            
            let html = "";
            let currentWeekKey = "";
            let weekSumMin = 0;

            history.forEach((item, index) => {
                const weekKey = `${item.year}-W${item.week}`;
                if (currentWeekKey !== "" && currentWeekKey !== weekKey) {
                    html += `<div class="week-separator"><span>KW ${currentWeekKey.split('-W')[1]}</span><span>Summe: ${formatTime(weekSumMin)}</span></div>`;
                    weekSumMin = 0;
                }
                currentWeekKey = weekKey;
                weekSumMin += item.netMin;

                html += `
                    <div class="history-item" onclick="openEdit(${item.id})">
                        <div><b>${item.dateDisplay}</b> <span style="opacity:0.5; font-size:9px;">(${item.start}-${item.end})</span></div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <span style="color:${item.otText.includes('+') ? 'var(--success)' : 'var(--danger)'}; font-weight:bold;">${item.otText}</span>
                            <button class="delete-btn" onclick="deleteDay(event, ${item.id})">Ã—</button>
                        </div>
                    </div>
                `;

                if (index === history.length - 1) {
                    html += `<div class="week-separator"><span>KW ${weekKey.split('-W')[1]}</span><span>Summe: ${formatTime(weekSumMin)}</span></div>`;
                }
            });
            list.innerHTML = html;
        }

        function exportCSV() {
            const history = JSON.parse(localStorage.getItem('workHistoryFull') || '[]');
            if (history.length === 0) return;
            const sortedHistory = [...history].sort((a, b) => a.id - b.id);
            let csvContent = "data:text/csv;charset=utf-8,";
            csvContent += "Wochentag;Datum;Beginn;Ende;Pause;Netto;Saldo;Wochensumme\n";
            let cw = null; let cy = null; let ws = 0;

            sortedHistory.forEach((item, index) => {
                if (cw !== null && (cw !== item.week || cy !== item.year)) {
                    csvContent += `;;;;;SUMME:;${formatTime(ws)};35h Soll\n\n`;
                    ws = 0;
                }
                cw = item.week; cy = item.year; ws += item.netMin;
                csvContent += `${item.dateDisplay.split(',')[0]};${item.fullDate};${item.start};${item.end};${item.pause};${formatTime(item.netMin)};${item.otText};\n`;
                if (index === sortedHistory.length - 1) {
                    csvContent += `;;;;;SUMME:;${formatTime(ws)};35h Soll\n`;
                }
            });
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", `Arbeitsstunden_Export.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        window.onload = () => { calculate(); renderHistory(); };
    </script>
</body>
</html>