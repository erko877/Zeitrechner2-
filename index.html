<!DOCTYPE html>
<html lang="de" data-theme="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="WorkTime Pro">
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2088/2088617.png">
    <link rel="icon" href="https://cdn-icons-png.flaticon.com/512/2088/2088617.png" type="image/png">

    <title>WorkTime Pro | Erko 2026</title>

    <style>
        :root {
            --bg-gradient: radial-gradient(at 0% 0%, #1e1b4b 0, transparent 50%), radial-gradient(at 100% 100%, #4338ca 0, transparent 50%);
            --glass: rgba(255, 255, 255, 0.05);
            --glass-border: rgba(255, 255, 255, 0.12);
            --text-main: #f8fafc;
            --primary: #818cf8;
            --success: #34d399;
            --danger: #fb7185;
            --accent: #22d3ee;
            --gold-gradient: linear-gradient(90deg, #bf953f, #fcf6ba, #b38728, #fbf5b7, #aa771c);
        }

        [data-theme="light"] {
            --bg-gradient: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
            --glass: rgba(255, 255, 255, 0.7);
            --glass-border: rgba(0, 0, 0, 0.08);
            --text-main: #1e293b;
            --primary: #4f46e5;
            --success: #10b981;
            --danger: #ef4444;
        }

        * { box-sizing: border-box; font-family: 'Inter', sans-serif; margin: 0; padding: 0; transition: background 0.3s ease, color 0.3s ease; }
        body { background: var(--bg-gradient); background-color: #0f172a; min-height: 100vh; display: flex; align-items: center; justify-content: center; color: var(--text-main); padding: 10px; }
        
        .dashboard { width: 100%; max-width: 900px; display: grid; grid-template-columns: 1fr 1.3fr; gap: 15px; }
        @media (max-width: 800px) { .dashboard { grid-template-columns: 1fr; } body { align-items: flex-start; padding-top: 40px; } }

        .glass-card { background: var(--glass); backdrop-filter: blur(20px); border: 1px solid var(--glass-border); border-radius: 20px; padding: 20px; box-shadow: 0 15px 35px rgba(0, 0, 0, 0.3); }
        h1 { font-size: 18px; font-weight: 800; text-align: center; margin-bottom: 15px; background: linear-gradient(to right, #fff, var(--primary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; }
        label { display: block; font-size: 9px; font-weight: 700; text-transform: uppercase; color: var(--primary); margin-bottom: 4px; }

        .compact-row { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; margin-bottom: 12px; }
        .selector-box { display: flex; background: rgba(0,0,0,0.15); padding: 3px; border-radius: 10px; border: 1px solid var(--glass-border); }
        .sel-btn { flex: 1; padding: 6px; border: none; background: none; color: var(--text-main); font-size: 9px; font-weight: 800; cursor: pointer; border-radius: 7px; text-transform: uppercase; }
        .sel-btn.active { background: var(--primary); color: white; box-shadow: 0 2px 8px rgba(0,0,0,0.2); }

        .input-row { display: flex; gap: 6px; margin-bottom: 12px; align-items: center; }
        input { width: 100%; padding: 10px; border-radius: 10px; border: 1px solid var(--glass-border); background: rgba(0, 0, 0, 0.1); color: var(--text-main); font-size: 15px; outline: none; }
        [data-theme="light"] input { background: rgba(255, 255, 255, 0.5); }
        
        .btn-icon { background: var(--primary); border: none; color: white; width: 42px; height: 42px; border-radius: 10px; cursor: pointer; display: flex; align-items: center; justify-content: center; font-size: 16px; flex-shrink: 0; }

        .phase-box { background: rgba(0,0,0,0.1); padding: 10px; border-radius: 12px; border: 1px solid var(--glass-border); margin-bottom: 8px; }
        .phase-controls { display: grid; grid-template-columns: 1fr 1fr 35px; gap: 5px; margin-bottom: 6px; }
        .btn-add-phase { width: 100%; padding: 8px; border-radius: 10px; border: 1px dashed var(--primary); background: none; color: var(--primary); font-weight: 800; cursor: pointer; margin-bottom: 10px; font-size: 10px; }

        .toggle-btn { padding: 8px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(0,0,0,0.1); color: var(--text-main); font-size: 9px; font-weight: bold; cursor: pointer; flex: 1; text-align: center; }
        .toggle-btn.active { background: var(--primary); color: white; }

        .progress-wrapper { position: relative; height: 12px; background: rgba(0,0,0,0.2); border-radius: 6px; margin: 15px 0; overflow: hidden; border: 1px solid var(--glass-border); }
        #progress-bar { height: 100%; width: 0%; background: var(--danger); transition: width 0.4s ease; }
        .gold-shimmer { background: var(--gold-gradient) !important; background-size: 200% auto !important; animation: shine 3s linear infinite; box-shadow: 0 0 15px rgba(212, 175, 55, 0.4) !important; }
        @keyframes shine { to { background-position: 200% center; } }
        .marker { position: absolute; left: 77.7%; top: 0; bottom: 0; width: 2px; background: white; z-index: 5; }

        .finish-card { background: linear-gradient(135deg, rgba(129, 140, 248, 0.15), rgba(34, 211, 238, 0.15)); border: 1px solid var(--glass-border); border-radius: 15px; padding: 15px; text-align: center; margin-bottom: 15px; }
        .finish-time { font-size: 28px; font-weight: 900; color: var(--accent); }

        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
        .stat-box { background: rgba(0,0,0,0.1); padding: 12px; border-radius: 12px; text-align: center; border: 1px solid var(--glass-border); }
        
        .save-btn { width: 100%; padding: 12px; border-radius: 12px; border: none; background: var(--success); color: #064e3b; font-weight: 800; cursor: pointer; margin-top: 20px; font-size: 14px; }

        .history-item { display: flex; justify-content: space-between; align-items: center; padding: 10px 5px; border-bottom: 1px solid var(--glass-border); font-size: 11px; cursor: pointer; }
        .delete-btn { color: var(--danger); background: none; border: none; font-size: 18px; cursor: pointer; padding: 5px; opacity: 0.5; }
        .week-separator { margin-top: 15px; padding-bottom: 3px; border-bottom: 1.5px solid var(--accent); display: flex; justify-content: space-between; font-size: 9px; font-weight: 800; color: var(--accent); text-transform: uppercase; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); display: none; align-items: center; justify-content: center; z-index: 1000; padding: 20px; }
        .modal-content { width: 100%; max-width: 350px; }

        .theme-toggle { position: fixed; top: 10px; right: 10px; background: var(--glass); border: 1px solid var(--glass-border); color: var(--text-main); padding: 8px; border-radius: 50%; z-index: 100; cursor: pointer; font-size: 16px; display: flex; align-items: center; justify-content: center; }

        .history-actions { display: flex; gap: 4px; }
        .action-btn { font-size: 8px; border: 1px solid var(--glass-border); background: none; color: var(--text-main); padding: 3px 6px; border-radius: 5px; cursor: pointer; text-transform: uppercase; font-weight: 700; }
        .action-btn:hover { background: rgba(255,255,255,0.1); }
        .action-btn:disabled { opacity: 0.3; cursor: default; }
    </style>
</head>
<body>

    <button class="theme-toggle" onclick="toggleTheme()">üåì</button>

    <div class="modal-overlay" id="editModal">
        <div class="glass-card modal-content">
            <h1 style="font-size: 16px;">Eintrag bearbeiten</h1>
            <div id="editContainer"></div>
            <div style="display: flex; gap: 10px; margin-top:15px;">
                <button class="save-btn" onclick="applyEdit()" style="margin: 0; flex: 2;">Speichern</button>
                <button class="save-btn" onclick="closeEdit()" style="margin: 0; flex: 1; background: rgba(255,255,255,0.1); color: var(--text-main);">X</button>
            </div>
        </div>
    </div>

    <div class="dashboard">
        <div class="controls glass-card">
            <h1>WorkTime Pro</h1>
            
            <label>Modus & Ziel</label>
            <div class="compact-row">
                <div class="selector-box">
                    <button id="mEasy" class="sel-btn active" onclick="setMode('easy')">Easy</button>
                    <button id="mPro" class="sel-btn" onclick="setMode('pro')">Pro</button>
                </div>
                <div class="selector-box">
                    <button id="t7h" class="sel-btn active" onclick="setTarget(420)">7h</button>
                    <button id="t8h" class="sel-btn" onclick="setTarget(480)">8h</button>
                </div>
            </div>

            <div id="ui-easy">
                <label>Beginn</label>
                <div class="input-row">
                    <input type="time" id="start" value="08:00" oninput="calculate(); autoSave();">
                    <button class="btn-icon" onclick="setNow('start')">üïí</button>
                </div>
                <label>Ende</label>
                <div class="input-row">
                    <input type="time" id="end" value="15:30" oninput="calculate(); autoSave();">
                    <button class="btn-icon" onclick="setNow('end')">üïí</button>
                </div>
                <div class="compact-row" style="margin-bottom: 0;">
                    <div><label>Pause</label><input type="number" id="pause" value="30" oninput="calculate(); autoSave();"></div>
                    <div><label>Ort</label><button id="hoT" class="toggle-btn" style="height:39px; width:100%" onclick="isEasyHO=!isEasyHO; updHO(); calculate(); autoSave();">üè¢ Buero</button></div>
                </div>
            </div>

            <div id="ui-pro" style="display:none;">
                <label>Hybrid Phasen</label>
                <div id="pList"></div>
                <button class="btn-add-phase" onclick="addPhase()">+ Phase hinzuf√ºgen</button>
                <label>Zusatz-Pause (Min)</label>
                <input type="number" id="proP" value="0" oninput="calculate(); autoSave();" style="margin-bottom:10px;">
            </div>

            <button class="save-btn" onclick="saveDay()">TAG SPEICHERN</button>
        </div>

        <div class="visuals glass-card">
            <div class="finish-card">
                <label id="target-lbl" style="color:var(--text-main); opacity: 0.6; font-size: 8px;">FEIERABEND (7H)</label>
                <div id="finish-time" class="finish-time">--:--</div>
            </div>
            <div class="progress-wrapper"><div id="marker-line" class="marker"></div><div id="progress-bar"></div></div>
            <div class="stats-grid">
                <div class="stat-box"><label>Netto</label><div id="out-net" style="font-size: 16px; font-weight: 800;">0h 0m</div></div>
                <div class="stat-box"><label>Saldo</label><div id="out-over" style="font-size: 16px; font-weight: 800;">0h 0m</div></div>
            </div>

            <!-- HISTORIE HEADER JETZT IMMER SICHTBAR -->
            <div id="history-container" style="margin-top:20px; border-top: 1px solid var(--glass-border); padding-top: 15px;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                    <label>Historie</label>
                    <div class="history-actions">
                        <button class="action-btn" id="csvBtn" onclick="askExport()">CSV</button>
                        <button class="action-btn" id="backupBtn" onclick="backupData()">Backup</button>
                        <button class="action-btn" onclick="triggerImport()">Import</button>
                        <input type="file" id="importFile" style="display:none" accept=".json" onchange="handleImport(event)">
                    </div>
                </div>
                <div id="history-list"></div>
            </div>
            
            <p style="text-align: center; font-size: 8px; opacity: 0.3; margin-top: 15px;">&copy; Erko 2026</p>
        </div>
    </div>

    <script>
        let mode = 'easy', targetMin = 420, isEasyHO = false, editingId = null;
        let proPhases = [{ id: Date.now(), s: "08:00", e: "12:00", ho: true }];

        function toggleTheme() {
            const d = document.documentElement;
            const t = d.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            d.setAttribute('data-theme', t);
            localStorage.setItem('erko_theme', t);
        }

        function setMode(m) {
            mode = m;
            document.getElementById('mEasy').classList.toggle('active', m === 'easy');
            document.getElementById('mPro').classList.toggle('active', m === 'pro');
            document.getElementById('ui-easy').style.display = m === 'easy' ? 'block' : 'none';
            document.getElementById('ui-pro').style.display = m === 'pro' ? 'block' : 'none';
            if(m === 'pro') renderPhases();
            calculate(); autoSave();
        }

        function setTarget(min) {
            targetMin = min;
            document.getElementById('t7h').classList.toggle('active', min === 420);
            document.getElementById('t8h').classList.toggle('active', min === 480);
            document.getElementById('target-lbl').innerText = `FEIERABEND (${min/60}H)`;
            document.getElementById('marker-line').style.left = (min / 540 * 100) + "%";
            calculate(); autoSave();
        }

        function updHO() {
            const b = document.getElementById('hoT');
            b.classList.toggle('active', isEasyHO);
            b.innerText = isEasyHO ? "üè† HO" : "üè¢ Buero";
        }

        function addPhase() {
            const last = proPhases[proPhases.length-1];
            proPhases.push({ id: Date.now(), s: last ? last.e : "12:00", e: "", ho: false });
            renderPhases(); calculate(); autoSave();
        }

        function renderPhases() {
            const list = document.getElementById('pList');
            list.innerHTML = "";
            proPhases.forEach((p, idx) => {
                const div = document.createElement('div');
                div.className = "phase-box";
                div.innerHTML = `
                    <div class="phase-controls">
                        <input type="time" value="${p.s}" class="pro-s" oninput="syncPhases(); calculate();">
                        <input type="time" value="${p.e}" class="pro-e" oninput="syncPhases(); calculate();">
                        <button style="color:var(--danger); background:none; border:none; font-size:18px; cursor:pointer;" onclick="proPhases=proPhases.filter(x=>x.id!==${p.id}); renderPhases(); calculate(); autoSave();">√ó</button>
                    </div>
                    <div style="display:flex; gap:5px;">
                        <button class="toggle-btn ${p.ho?'active':''}" onclick="proPhases[${idx}].ho=true; renderPhases(); calculate();">üè† HO</button>
                        <button class="toggle-btn ${!p.ho?'active':''}" onclick="proPhases[${idx}].ho=false; renderPhases(); calculate();">üè¢ Buero</button>
                    </div>`;
                list.appendChild(div);
            });
        }

        function syncPhases() {
            const ss = document.querySelectorAll('.pro-s');
            const ee = document.querySelectorAll('.pro-e');
            ss.forEach((s, i) => { proPhases[i].s = s.value; proPhases[i].e = ee[i].value; });
            autoSave();
        }

        function calculate() {
            let net = 0, fStart = 0;
            if (mode === 'easy') {
                const s = document.getElementById('start').value, e = document.getElementById('end').value, p = parseInt(document.getElementById('pause').value) || 0;
                if(s && e) {
                    const [sh, sm] = s.split(':').map(Number), [eh, em] = e.split(':').map(Number);
                    fStart = sh * 60 + sm; let d = (eh * 60 + em) - fStart; if(d < 0) d += 1440; net = d - p;
                }
            } else {
                const pP = parseInt(document.getElementById('proP').value) || 0;
                proPhases.forEach((p, i) => {
                    if(p.s && p.e) {
                        const [sh, sm] = p.s.split(':').map(Number), [eh, em] = p.e.split(':').map(Number);
                        if(i === 0) fStart = sh * 60 + sm;
                        let d = (eh * 60 + em) - (sh * 60 + sm); if(d < 0) d += 1440; net += d;
                    }
                });
                net -= pP;
            }
            document.getElementById('out-net').innerText = fmtT(net);
            const over = net - targetMin;
            const ovEl = document.getElementById('out-over');
            ovEl.innerText = (over >= 0 ? "+" : "") + fmtT(over);
            ovEl.style.color = over >= 0 ? "var(--success)" : "var(--danger)";
            const bar = document.getElementById('progress-bar');
            bar.style.width = Math.min((net / 540) * 100, 100) + "%";
            bar.className = net > targetMin ? "gold-shimmer" : "";
            bar.style.background = net >= targetMin ? "var(--success)" : "var(--danger)";
            if(fStart > 0) {
                const p = mode === 'easy' ? (parseInt(document.getElementById('pause').value) || 0) : (parseInt(document.getElementById('proP').value) || 0);
                const fMin = fStart + targetMin + p;
                document.getElementById('finish-time').innerText = `${String(Math.floor((fMin % 1440) / 60)).padStart(2,'0')}:${String(fMin % 60).padStart(2,'0')} Uhr`;
            }
        }

        function fmtT(m) { const a = Math.abs(m); return `${Math.floor(a/60)}h ${a%60}m`; }

        function saveDay() {
            const now = new Date();
            const data = {
                id: Date.now(), mode, target: targetMin,
                dateDisp: now.toLocaleDateString('de-DE', {weekday: 'short', day: '2-digit', month: '2-digit'}),
                fullDate: now.toLocaleDateString('de-DE'), week: getWN(now), year: now.getFullYear(),
                easy: { s: document.getElementById('start').value, e: document.getElementById('end').value, p: document.getElementById('pause').value, ho: isEasyHO },
                pro: { phases: JSON.parse(JSON.stringify(proPhases)), p: document.getElementById('proP').value },
                netMin: pNet(document.getElementById('out-net').innerText)
            };
            let h = JSON.parse(localStorage.getItem('erko_final_v13') || '[]');
            h.unshift(data); localStorage.setItem('erko_final_v13', JSON.stringify(h));
            renderHistory();
        }

        function pNet(s) { const p = s.split(' '); return parseInt(p[0])*60 + parseInt(p[1]); }

        function renderHistory() {
            const h = JSON.parse(localStorage.getItem('erko_final_v13') || '[]');
            const list = document.getElementById('history-list');
            
            // Buttons deaktivieren wenn keine Historie da ist
            document.getElementById('csvBtn').disabled = (h.length === 0);
            document.getElementById('backupBtn').disabled = (h.length === 0);

            if(h.length === 0) {
                list.innerHTML = `<p style="font-size: 10px; opacity: 0.3; text-align: center; margin-top: 20px;">Keine Eintr√§ge vorhanden.</p>`;
                return;
            }
            
            let html = "", cw = "", wsN = 0;
            h.forEach((item, idx) => {
                const wk = `${item.year}-W${item.week}`;
                if (cw !== "" && cw !== wk) { html += `<div class="week-separator"><span>KW ${cw.split('-W')[1]}</span><span>${fmtT(wsN)}</span></div>`; wsN = 0; }
                cw = wk; wsN += item.netMin;
                const over = item.netMin - item.target;
                const icons = item.mode === 'easy' ? (item.easy.ho ? 'üè†' : 'üè¢') : [...new Set(item.pro.phases.map(p => p.ho ? 'üè†' : 'üè¢'))].join('');
                html += `<div class="history-item" onclick="openEdit(${item.id})">
                    <span><b>${item.dateDisp}</b> ${icons}</span>
                    <div style="display:flex; align-items:center;">
                        <span style="color:${over >= 0 ? 'var(--success)' : 'var(--danger)'}; font-weight:bold;">${(over >= 0 ? '+':'-') + fmtT(over)}</span>
                        <button class="delete-btn" onclick="event.stopPropagation(); deleteE(${item.id})">√ó</button>
                    </div>
                </div>`;
                if (idx === h.length - 1) html += `<div class="week-separator"><span>KW ${wk.split('-W')[1]}</span><span>${fmtT(wsN)}</span></div>`;
            });
            list.innerHTML = html;
        }

        function deleteE(id) {
            if(confirm("Eintrag loeschen?")) {
                let h = JSON.parse(localStorage.getItem('erko_final_v13') || '[]');
                h = h.filter(i => i.id !== id);
                localStorage.setItem('erko_final_v13', JSON.stringify(h));
                renderHistory();
            }
        }

        function openEdit(id) {
            editingId = id;
            const h = JSON.parse(localStorage.getItem('erko_final_v13'));
            const item = h.find(i => i.id === id);
            const container = document.getElementById('editContainer');
            container.innerHTML = "";
            if(item.mode === 'easy') {
                container.innerHTML = `<label>Start</label><input type="time" id="edS" value="${item.easy.s}"><label>Ende</label><input type="time" id="edE" value="${item.easy.e}"><label>Pause</label><input type="number" id="edP" value="${item.easy.p}"><label>Ort</label><button class="toggle-btn ${item.easy.ho?'active':''}" id="edHO" onclick="this.classList.toggle('active'); this.innerText = this.classList.contains('active') ? 'üè† HO' : 'üè¢ Buero'">${item.easy.ho?'üè† HO':'üè¢ Buero'}</button>`;
            } else {
                item.pro.phases.forEach((p, i) => {
                    container.innerHTML += `<div class="phase-box"><label>Phase ${i+1}</label><div class="phase-controls"><input type="time" class="edPS" value="${p.s}"><input type="time" class="edPE" value="${p.e}"></div><button class="toggle-btn ${p.ho?'active':''}" onclick="this.classList.toggle('active'); this.innerText = this.classList.contains('active') ? 'üè† HO' : 'üè¢ Buero'">${p.ho?'üè† HO':'üè¢ Buero'}</button></div>`;
                });
                container.innerHTML += `<label>Pause</label><input type="number" id="edPP" value="${item.pro.p}">`;
            }
            document.getElementById('editModal').style.display = 'flex';
        }

        function applyEdit() {
            let h = JSON.parse(localStorage.getItem('erko_final_v13'));
            const item = h.find(i => i.id === editingId);
            let n = 0;
            if(item.mode === 'easy') {
                item.easy.s = document.getElementById('edS').value; item.easy.e = document.getElementById('edE').value; 
                item.easy.p = parseInt(document.getElementById('edP').value) || 0;
                item.easy.ho = document.getElementById('edHO').classList.contains('active');
                const [sh, sm] = item.easy.s.split(':').map(Number), [eh, em] = item.easy.e.split(':').map(Number);
                let d = (eh*60+em)-(sh*60+sm); if(d < 0) d += 1440; n = d - item.easy.p;
            } else {
                const sI = document.querySelectorAll('.edPS'), eI = document.querySelectorAll('.edPE'), hoI = document.querySelectorAll('#editModal .toggle-btn'), pP = parseInt(document.getElementById('edPP').value) || 0;
                item.pro.phases.forEach((p, i) => {
                    p.s = sI[i].value; p.e = eI[i].value; p.ho = hoI[i].classList.contains('active');
                    const [sh, sm] = p.s.split(':').map(Number), [eh, em] = p.e.split(':').map(Number);
                    let d = (eh*60+em)-(sh*60+sm); if(d < 0) d += 1440; n += d;
                });
                item.pro.p = pP; n -= pP;
            }
            item.netMin = n; localStorage.setItem('erko_final_v13', JSON.stringify(h)); renderHistory(); closeEdit();
        }

        function closeEdit() { document.getElementById('editModal').style.display = 'none'; }
        function getWN(d) { d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate())); d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay() || 7)); var s = new Date(Date.UTC(d.getUTCFullYear(), 0, 1)); return Math.ceil((((d - s) / 86400000) + 1) / 7); }
        function setNow(id) { const d = new Date(); document.getElementById(id).value = d.getHours().toString().padStart(2,'0') + ":" + d.getMinutes().toString().padStart(2,'0'); calculate(); autoSave(); }
        function autoSave() { const data = { mode, targetMin, isEasyHO, easy: { s: document.getElementById('start').value, e: document.getElementById('end').value, p: document.getElementById('pause').value }, pro: { phases: proPhases, p: document.getElementById('proP').value } }; localStorage.setItem('erko_live_v13', JSON.stringify(data)); }

        function load() {
            const theme = localStorage.getItem('erko_theme') || 'dark';
            document.documentElement.setAttribute('data-theme', theme);
            const live = JSON.parse(localStorage.getItem('erko_live_v13'));
            if(live) {
                targetMin = live.targetMin || 420; isEasyHO = live.isEasyHO;
                document.getElementById('start').value = live.easy.s; document.getElementById('end').value = live.easy.e; document.getElementById('pause').value = live.easy.p;
                document.getElementById('proP').value = live.pro.p; proPhases = live.pro.phases;
                setMode(live.mode || 'easy'); setTarget(targetMin); updHO();
            }
            renderHistory(); calculate();
        }

        function backupData() {
            if (!confirm("Wollen Sie ein Backup erstellen?")) return;
            const data = localStorage.getItem('erko_final_v13');
            const blob = new Blob([data], {type: "application/json"});
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `WorkTime_Backup_${new Date().toLocaleDateString('de-DE')}.json`;
            link.click();
        }

        function triggerImport() { document.getElementById('importFile').click(); }

        function handleImport(event) {
            const file = event.target.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const imported = JSON.parse(e.target.result);
                    if(confirm("Dies wird deine aktuelle Historie durch das Backup ersetzen. Fortfahren?")) {
                        localStorage.setItem('erko_final_v13', JSON.stringify(imported));
                        renderHistory();
                        alert("Daten erfolgreich wiederhergestellt!");
                    }
                } catch(err) { alert("Fehler: Ungueltige Backup-Datei."); }
            };
            reader.readAsText(file);
        }

        function askExport() { if(confirm("Moechtest du die Historie als CSV exportieren?")) exportCSV(); }
        
        function exportCSV() {
            const h = JSON.parse(localStorage.getItem('erko_final_v13') || '[]');
            if (h.length === 0) return;
            const sortedH = [...h].sort((a,b) => a.id - b.id);
            let csv = "\ufeffKW;Datum;Tag;Arbeitsbeginn;Arbeitsende;Ort;Netto;Saldo\n";
            let cw = null, cy = null, cm = null;
            let wsN = 0, wsS = 0, msN = 0, msS = 0, gtN = 0, gtS = 0;

            sortedH.forEach((item, idx) => {
                const [d, m, y] = item.fullDate.split('.').map(Number);
                if (cw !== null && (cw !== item.week || cy !== item.year)) {
                    csv += `;;;;;SUMME KW ${cw}:;${fmtT(wsN)};${(wsS>=0?'+':'-')+fmtT(wsS)}\n`;
                    wsN = 0; wsS = 0;
                }
                if (cm !== null && cm !== m) {
                    csv += `;;;;;SUMME MONAT:;${fmtT(msN)};${(msS>=0?'+':'-')+fmtT(msS)}\n\n`;
                    msN = 0; msS = 0;
                }
                cw = item.week; cy = item.year; cm = m;
                const tag = item.dateDisp.split(',')[0];
                const daySaldo = item.netMin - item.target;
                wsN += item.netMin; wsS += daySaldo; msN += item.netMin; msS += daySaldo; gtN += item.netMin; gtS += daySaldo;

                if (item.mode === 'easy') {
                    csv += `${item.week};${item.fullDate};${tag};${item.easy.s};${item.easy.e};${(item.easy.ho ? 'HO' : 'Buero')};${fmtT(item.netMin)};${(daySaldo>=0?'+':'-')+fmtT(daySaldo)}\n`;
                } else {
                    item.pro.phases.forEach((p, pIdx) => {
                        const [sh, sm] = p.s.split(':').map(Number), [eh, em] = p.e.split(':').map(Number);
                        let diff = (eh * 60 + em) - (sh * 60 + sm); if(diff < 0) diff += 1440;
                        const saldoField = (pIdx === item.pro.phases.length - 1) ? (daySaldo>=0?'+':'-')+fmtT(daySaldo) : "";
                        csv += `${item.week};${item.fullDate};${tag};${p.s};${p.e};${(p.ho ? 'HO' : 'Buero') + "-H"};${fmtT(diff)};${saldoField}\n`;
                    });
                }
                if (idx === sortedH.length - 1) {
                    csv += `;;;;;SUMME KW ${cw}:;${fmtT(wsN)};${(wsS>=0?'+':'-')+fmtT(wsS)}\n`;
                    csv += `;;;;;SUMME MONAT:;${fmtT(msN)};${(msS>=0?'+':'-')+fmtT(msS)}\n`;
                }
            });
            csv += `\n;;;;;GESAMTSUMME AKTUELL:;${fmtT(gtN)};${(gtS>=0?'+':'-')+fmtT(gtS)}\n`;
            const expD = new Date().toLocaleDateString('de-DE').replace(/\//g, '.');
            const link = document.createElement("a");
            link.href = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csv);
            link.download = `Arbeitszeit_Export_${expD}.csv`;
            link.click();
        }

        window.onload = load;
    </script>
</body>
</html>